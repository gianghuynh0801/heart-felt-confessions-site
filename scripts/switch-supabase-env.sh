
#!/bin/bash

# Định nghĩa các biến môi trường
PROD_URL="https://eknujhmrispkgzhrywfv.supabase.co"
PROD_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrbnVqaG1yaXNwa2d6aHJ5d2Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjIzNTQsImV4cCI6MjA2MTM5ODM1NH0.aQWyd4sla7_lls6ALGjXciTa0JnieySmWYJNTHM0ZEQ"
LOCAL_URL="http://localhost:54321"
LOCAL_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYyMjYxNDgyMiwiZXhwIjoxOTM4MTkwODIyfQ.ZDj4ZPXzyQy6LA7WL5RqWzF1NEg-QmP5ABHrGa_LBQI"
PROJECT_ID="eknujhmrispkgzhrywfv"
SCHEMA_FILE="./schema_backup.sql"
TEMP_DIR="./temp_schema"
MIGRATION_FILE="./migration_backup.sql"

# Hàm cập nhật file client.ts
update_client_file() {
    local env=$1
    local target_file="src/integrations/supabase/client.ts"
    
    if [ "$env" = "local" ]; then
        url=$LOCAL_URL
        key=$LOCAL_KEY
        echo "Chuyển sang môi trường Local Supabase..."
    else
        url=$PROD_URL
        key=$PROD_KEY
        echo "Chuyển sang môi trường Production Supabase..."
    fi
    
    # Tạo nội dung file mới
    cat > "$target_file" << EOF
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "${url}";
const SUPABASE_PUBLISHABLE_KEY = "${key}";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
EOF

    echo "Đã cập nhật file $target_file thành công!"
}

# Kiểm tra Supabase CLI đã được cài đặt chưa
check_supabase_cli() {
    if ! command -v supabase &> /dev/null; then
        echo "Supabase CLI chưa được cài đặt. Vui lòng cài đặt theo các bước sau:"
        echo "1. Cài đặt Supabase CLI:"
        echo "   npm install -g supabase"
        echo "2. Login vào Supabase:"
        echo "   supabase login"
        exit 1
    fi
}

# Backup schema và migration từ production
backup_schema() {
    echo "Đang sao lưu schema từ Supabase production..."
    
    # Tạo thư mục tạm nếu chưa tồn tại
    mkdir -p $TEMP_DIR
    
    # Sao lưu schema hiện tại
    echo "Đang sao lưu schema..."
    supabase db dump --db-url "postgresql://postgres:postgres@$PROD_URL:5432/postgres" -f $SCHEMA_FILE
    
    if [ $? -eq 0 ]; then
        echo "Sao lưu schema thành công: $SCHEMA_FILE"
    else
        echo "Sao lưu schema thất bại!"
        exit 1
    fi

    # Sao lưu migration history
    echo "Đang sao lưu migration history..."
    supabase db dump --db-url "postgresql://postgres:postgres@$PROD_URL:5432/postgres" --migration-table -f $MIGRATION_FILE
    
    if [ $? -eq 0 ]; then
        echo "Sao lưu migration history thành công: $MIGRATION_FILE"
    else
        echo "Sao lưu migration history thất bại!"
        exit 1
    fi
}

# Khôi phục schema vào local
restore_schema() {
    echo "Đang khôi phục database vào Supabase local..."
    
    # Reset database local
    echo "Đang reset database local..."
    supabase db reset --db-url "postgresql://postgres:postgres@localhost:54321/postgres"
    
    if [ $? -eq 0 ]; then
        echo "Reset database local thành công"
    else
        echo "Reset database local thất bại!"
        exit 1
    fi
    
    # Khôi phục schema
    echo "Đang khôi phục schema..."
    supabase db push --db-url "postgresql://postgres:postgres@localhost:54321/postgres" -f $SCHEMA_FILE
    
    if [ $? -eq 0 ]; then
        echo "Khôi phục schema thành công"
    else
        echo "Khôi phục schema thất bại!"
        exit 1
    fi
    
    # Khôi phục migration history
    echo "Đang khôi phục migration history..."
    supabase db push --db-url "postgresql://postgres:postgres@localhost:54321/postgres" -f $MIGRATION_FILE
    
    if [ $? -eq 0 ]; then
        echo "Khôi phục migration history thành công"
    else
        echo "Khôi phục migration history thất bại!"
        exit 1
    fi
}

# Kiểm tra status của Supabase local
check_local_status() {
    echo "Kiểm tra trạng thái Supabase local..."
    supabase status
    
    if [ $? -ne 0 ]; then
        echo "Supabase local chưa được khởi động. Đang khởi động..."
        supabase start
    fi
}

# Hiển thị hướng dẫn sử dụng
show_usage() {
    echo "Sử dụng: $0 [local|prod|backup|restore|sync]"
    echo "  local:   Chuyển sang môi trường Local Supabase"
    echo "  prod:    Chuyển sang môi trường Production Supabase"
    echo "  backup:  Sao lưu schema và migration từ Supabase Production"
    echo "  restore: Khôi phục schema và migration vào Supabase Local"
    echo "  sync:    Thực hiện toàn bộ quá trình (backup -> restore -> switch to local)"
    exit 1
}

# Xử lý tham số đầu vào
case "$1" in
    "local"|"prod")
        update_client_file $1
        ;;
    "backup")
        check_supabase_cli
        backup_schema
        ;;
    "restore")
        check_supabase_cli
        check_local_status
        restore_schema
        ;;
    "sync")
        check_supabase_cli
        check_local_status
        backup_schema
        restore_schema
        update_client_file "local"
        ;;
    *)
        show_usage
        ;;
esac

